<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #search-container { padding: 10px; background: white; z-index: 1000; }
        #address { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        #suggestions { list-style: none; padding: 0; margin: 5px 0 0; background: white; border: 1px solid #ccc; border-radius: 5px; max-height: 150px; overflow-y: auto; display: none; }
        #suggestions li { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
        #suggestions li:hover { background: #f0f0f0; }
        #map { flex: 1; width: 100%; }
        #footer { padding: 10px; background: white; border-top: 1px solid #ddd; display: flex; gap: 8px; flex-wrap: wrap; }
        #footer button { flex: 1; padding: 12px; font-size: 16px; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; }
        #confirm-btn { background: #007AFF; color: white; }
        #confirm-btn:disabled { background: #ccc; cursor: not-allowed; }
        #location-btn { background: #34C759; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status { text-align: center; margin-top: 8px; color: #666; font-size: 14px; width: 100%; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { color: #FF3B30; }
        .debug { font-size: 10px; color: #999; text-align: left; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="search-container">
        <input type="text" id="address" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é" autocomplete="off" autofocus>
        <ul id="suggestions"></ul>
    </div>
    <div id="map"></div>
    <div id="footer">
        <button id="location-btn">
            üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        </button>
        <button id="confirm-btn" disabled>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å</button>
        <div class="status" id="status">üìç –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
        <div class="debug" id="debug"></div>
    </div>

    <script>
        // Telegram WebApp
        let tg = window.Telegram?.WebApp;
        let debugEl = document.getElementById('debug');
        
        function logDebug(msg) {
            console.log(msg);
            if (debugEl) {
                debugEl.innerHTML += msg + '<br>';
            }
        }

        logDebug('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        
        if (tg) {
            tg.ready();
            tg.expand();
            logDebug('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –≤–µ—Ä—Å–∏—è: ' + tg.version);
            logDebug('initData: ' + (tg.initData ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'));
        } else {
            logDebug('‚ùå Telegram WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ');
        }

        let map;
        let marker;
        let selectedCoords = null;
        let selectedAddress = "";
        let isProcessing = false;

        // –¶–µ–Ω—Ç—Ä –¢–∞—à–∫–µ–Ω—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const defaultCenter = [41.311, 69.279];

        map = L.map('map').setView(defaultCenter, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // –ú–∞—Ä–∫–µ—Ä (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç)
        marker = L.marker(defaultCenter, {draggable: true}).addTo(map);
        marker.on('dragend', onMarkerDragEnd);
        map.removeLayer(marker); // —Å–∫—Ä—ã–≤–∞–µ–º –¥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞
        logDebug('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        function reverseGeocode(lat, lon, callback) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = '<span class="loader"></span> –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...';
            logDebug(`–û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: ${lat}, ${lon}`);
            
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`)
                .then(r => r.json())
                .then(data => {
                    logDebug('–û—Ç–≤–µ—Ç Nominatim: ' + (data.display_name || '–Ω–µ—Ç –∞–¥—Ä–µ—Å–∞'));
                    selectedAddress = data.display_name || `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    document.getElementById('address').value = selectedAddress;
                    document.getElementById('confirm-btn').disabled = false;
                    statusEl.innerText = '‚úÖ –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω';
                    if (callback) callback(selectedAddress);
                })
                .catch(err => {
                    logDebug('–û—à–∏–±–∫–∞ Nominatim: ' + err);
                    selectedAddress = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    document.getElementById('address').value = selectedAddress;
                    document.getElementById('confirm-btn').disabled = false;
                    statusEl.innerText = '‚úÖ –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω (–ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º)';
                    if (callback) callback(selectedAddress);
                });
        }

        function onMarkerDragEnd(e) {
            const pos = e.target.getLatLng();
            selectedCoords = [pos.lat, pos.lng];
            logDebug(`–ú–∞—Ä–∫–µ—Ä –ø–µ—Ä–µ–º–µ—â—ë–Ω: ${pos.lat}, ${pos.lng}`);
            reverseGeocode(pos.lat, pos.lng);
        }

        // –ü–æ–∏—Å–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫
        let timeoutId = null;
        document.getElementById('address').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (query.length < 3) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }
            if (timeoutId) clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fetchSuggestions(query), 300);
        });

        function fetchSuggestions(query) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=10&countrycodes=uz`;
            logDebug('–ü–æ–∏—Å–∫: ' + query);
            fetch(url, { headers: { 'User-Agent': 'TaxiBot/1.0' } })
                .then(r => r.json())
                .then(data => displaySuggestions(data))
                .catch(err => console.error('Nominatim error:', err));
        }

        function displaySuggestions(items) {
            const list = document.getElementById('suggestions');
            list.innerHTML = '';
            if (items.length === 0) {
                list.style.display = 'none';
                return;
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.display_name;
                li.addEventListener('click', () => selectSuggestion(item));
                list.appendChild(li);
            });
            list.style.display = 'block';
            logDebug('–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ–¥—Å–∫–∞–∑–æ–∫: ' + items.length);
        }

        function selectSuggestion(item) {
            document.getElementById('suggestions').style.display = 'none';
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);
            selectedCoords = [lat, lon];
            selectedAddress = item.display_name;
            document.getElementById('address').value = selectedAddress;
            document.getElementById('confirm-btn').disabled = false;
            document.getElementById('status').innerText = '‚úÖ –ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω –∏–∑ —Å–ø–∏—Å–∫–∞';
            logDebug(`–í—ã–±—Ä–∞–Ω–æ –∏–∑ —Å–ø–∏—Å–∫–∞: ${lat}, ${lon} - ${selectedAddress}`);

            if (!map.hasLayer(marker)) marker.addTo(map);
            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 15);
        }

        // –ö–Ω–æ–ø–∫–∞ "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
        document.getElementById('location-btn').addEventListener('click', function() {
            logDebug('–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"');
            if (!navigator.geolocation) {
                document.getElementById('status').innerText = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                logDebug('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }
            document.getElementById('status').innerHTML = '<span class="loader"></span> –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    logDebug(`–ü–æ–ª—É—á–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lon}`);
                    selectedCoords = [lat, lon];
                    if (!map.hasLayer(marker)) marker.addTo(map);
                    marker.setLatLng([lat, lon]);
                    map.setView([lat, lon], 15);
                    reverseGeocode(lat, lon, () => {
                        document.getElementById('status').innerText = 'üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ';
                    });
                },
                function(err) {
                    logDebug('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ' + err.message);
                    document.getElementById('status').innerText = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                }
            );
        });

        // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        document.getElementById('confirm-btn').addEventListener('click', function() {
            logDebug('=== –ù–ê–ñ–ê–¢–ê –ö–ù–û–ü–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø ===');
            if (isProcessing || !selectedCoords) {
                logDebug('–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç');
                return;
            }
            isProcessing = true;
            document.getElementById('status').innerHTML = '<span class="loader"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            const result = {
                lat: selectedCoords[0],
                lon: selectedCoords[1],
                address: selectedAddress
            };
            
            logDebug('–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + JSON.stringify(result));
            
            if (tg) {
                try {
                    logDebug('–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ tg.sendData()...');
                    tg.sendData(JSON.stringify(result));
                    logDebug('‚úÖ tg.sendData() –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                    logDebug('–ó–∞–∫—Ä—ã–≤–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
                    tg.close();
                } catch (e) {
                    logDebug('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: ' + e.message);
                    document.getElementById('status').innerHTML = '<span class="error">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</span>';
                    isProcessing = false;
                }
            } else {
                logDebug('‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–Ω–µ—Ç tg)');
                alert('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º):\n' + JSON.stringify(result));
                isProcessing = false;
                document.getElementById('status').innerText = '–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω (—Ç–µ—Å—Ç)';
            }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω
        logDebug('–ü—Ä–æ–≤–µ—Ä–∫–∞ tg.sendData: ' + (tg && typeof tg.sendData === 'function' ? '–¥–æ—Å—Ç—É–ø–Ω–∞' : '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'));
    </script>
</body>
</html>
