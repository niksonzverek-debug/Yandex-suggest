<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=05bead68-7d43-45f3-92ac-a086140b1f39&suggest_apikey=c26df761-b526-4c54-a189-34d436e07268&lang=ru_RU&load=Map,Placemark,geocode,control.SuggestView" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #map { flex: 1; width: 100%; }
        .search-panel { padding: 12px; background: white; border-bottom: 1px solid #ddd; }
        #address { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        #status { text-align: center; padding: 8px; font-size: 14px; color: #666; }
        .error { color: #d32f2f; }
        .success { color: #388e3c; }
    </style>
</head>
<body>
    <div class="search-panel">
        <input type="text" id="address" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ì—É–ª—å—Å–∞—Ä–∞)" autocomplete="off" autofocus>
    </div>
    <div id="map"></div>
    <div id="status">‚¨ÜÔ∏è –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞</div>

    <script>
        let map;
        let isProcessing = false;

        ymaps.ready(init);

        function init() {
            console.log('‚úÖ API –∑–∞–≥—Ä—É–∂–µ–Ω');
            map = new ymaps.Map('map', {
                center: [41.311, 69.279],
                zoom: 12
            });

            var suggestView = new ymaps.controls.SuggestView('address');
            suggestView.events.add('select', function (e) {
                if (isProcessing) return;
                isProcessing = true;
                var item = e.get('item');
                var selectedAddress = item.displayName;
                setStatus('üîç –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã...', '');

                ymaps.geocode(selectedAddress).then(function (res) {
                    var first = res.geoObjects.get(0);
                    if (first) {
                        var coords = first.geometry.getCoordinates();
                        var fullAddress = first.getAddressLine() || selectedAddress;
                        map.geoObjects.removeAll();
                        map.geoObjects.add(new ymaps.Placemark(coords, { balloonContent: fullAddress }));
                        map.setCenter(coords, 15);
                        setStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞...', 'success');
                        sendData(fullAddress, coords);
                    } else {
                        throw new Error('–ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –¥–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
                    }
                }).catch(function (err) {
                    console.error(err);
                    setStatus('‚ùå –û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∞–¥—Ä–µ—Å.', 'error');
                    isProcessing = false;
                });
            });

            suggestView.events.add('error', function (err) {
                console.error('–û—à–∏–±–∫–∞ SuggestView:', err);
                setStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫', 'error');
            });
        }

        function sendData(address, coords) {
            const result = { lat: coords[0], lon: coords[1], address: address };
            if (window.Telegram && Telegram.WebApp) {
                try {
                    Telegram.WebApp.sendData(JSON.stringify(result));
                    setTimeout(() => Telegram.WebApp.close(), 300);
                } catch (e) {
                    console.error(e);
                    setStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                    isProcessing = false;
                }
            } else {
                alert('‚úÖ –ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω!\n' + JSON.stringify(result));
                setStatus('‚úÖ –¢–µ—Å—Ç', 'success');
                isProcessing = false;
            }
        }

        function setStatus(text, className) {
            document.getElementById('status').textContent = text;
            document.getElementById('status').className = className || '';
        }
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
