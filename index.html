<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã —Å —Ç–≤–æ–∏–º–∏ –∫–ª—é—á–∞–º–∏ -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=05bead68-7d43-45f3-92ac-a086140b1f39&suggest_apikey=c26df761-b526-4c54-a189-34d436e07268&lang=ru_RU" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            display: none;
            z-index: 1000;
        }
        .status.success { background: rgba(40, 167, 69, 0.9); }
        .status.error { background: rgba(220, 53, 69, 0.9); }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status" class="status"></div>

    <script>
        let map = null;
        let isSending = false; // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

        ymaps.ready(init);

        function init() {
            console.log('‚úÖ API –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            map = new ymaps.Map('map', {
                center: [41.311, 69.279],
                zoom: 12
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞ –∫–∞—Ä—Ç—É
            var searchControl = new ymaps.control.SearchControl({
                options: {
                    float: 'right',
                    noPlacemark: true,        // –Ω–µ —Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –º—ã —Å–∞–º–∏ –ø–æ—Å—Ç–∞–≤–∏–º
                    provider: 'yandex#search'
                }
            });
            map.controls.add(searchControl);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –ø–æ–∏—Å–∫–µ
            searchControl.events.add('resultselect', function (e) {
                if (isSending) return;
                isSending = true;
                var index = e.get('index');
                searchControl.getResult(index).then(function (res) {
                    var coords = res.geometry.getCoordinates();
                    var address = res.properties.get('name');
                    console.log('‚úÖ –í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç–æ:', address, coords);
                    sendResult(address, coords);
                }).catch(function (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', err);
                    showStatus('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
                    isSending = false;
                });
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è "load" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª Enter, –ø–æ—è–≤–∏–ª–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
            searchControl.events.add('load', function (e) {
                if (isSending) return;
                var results = e.get('target').getResultsArray();
                if (results && results.length > 0) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π (–æ–±—ã—á–Ω–æ —Å–∞–º—ã–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π)
                    var first = results[0];
                    var coords = first.geometry.getCoordinates();
                    var address = first.properties.get('name');
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ø–µ—Ä–≤—ã–π:', address, coords);
                    sendResult(address, coords);
                }
            });
        }

        function sendResult(address, coords) {
            const result = {
                lat: coords[0],
                lon: coords[1],
                address: address
            };
            console.log('üì¶ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', result);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏
            showStatus('‚úÖ –ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞...', 'success');

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ Mini App)
            if (window.Telegram && Telegram.WebApp) {
                try {
                    Telegram.WebApp.sendData(JSON.stringify(result));
                    console.log('üì§ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram');
                    showStatus('‚úÖ –ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(function() {
                        Telegram.WebApp.close();
                    }, 500);
                } catch (e) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', e);
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                    isSending = false;
                }
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∞ –≤–Ω–µ Telegram
                alert('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω:\n' + JSON.stringify(result));
                showStatus('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω', 'success');
                isSending = false;
            }
        }

        function showStatus(message, type) {
            var el = document.getElementById('status');
            el.textContent = message;
            el.className = 'status ' + (type || '');
            el.style.display = 'block';
            setTimeout(function() {
                el.style.display = 'none';
            }, 3000);
        }
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
