<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=05bead68-7d43-45f3-92ac-a086140b1f39&lang=ru_RU" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        #map { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let map = null;
        let selectedCoords = null;
        let selectedAddress = '';

        ymaps.ready(init);

        function init() {
            console.log('‚úÖ API –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

            // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ –¢–∞—à–∫–µ–Ω—Ç–µ
            map = new ymaps.Map('map', {
                center: [41.311, 69.279],
                zoom: 12
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä—è–º–æ –Ω–∞ –∫–∞—Ä—Ç—É
            var searchControl = new ymaps.control.SearchControl({
                options: {
                    float: 'right',
                    noPlacemark: false,
                    provider: 'yandex#search'
                }
            });
            map.controls.add(searchControl);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞
            searchControl.events.add('resultselect', function (e) {
                var index = e.get('index');
                searchControl.getResult(index).then(function (result) {
                    var coords = result.geometry.getCoordinates();
                    var address = result.properties.get('name') || result.properties.get('description');
                    console.log('‚úÖ –í—ã–±—Ä–∞–Ω–æ:', address, coords);
                    sendResult(address, coords);
                }).catch(function (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', err);
                });
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –º–µ—Ç–∫–µ –Ω–∞ –∫–∞—Ä—Ç–µ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç –Ω–∞ —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç)
            searchControl.events.add('load', function (e) {
                var results = e.get('target').getResultsArray();
                if (results && results.length > 0) {
                    // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                }
            });

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω–µ—Ç –ø–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–µ—Ç–∫–µ –Ω–∞ –∫–∞—Ä—Ç–µ
            map.events.add('click', function (e) {
                var coords = e.get('coords');
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (–æ–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
                ymaps.geocode(coords).then(function (res) {
                    var first = res.geoObjects.get(0);
                    if (first) {
                        var address = first.getAddressLine();
                        sendResult(address, coords);
                    }
                }).catch(function (err) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                });
            });
        }

        function sendResult(address, coords) {
            const result = {
                lat: coords[0],
                lon: coords[1],
                address: address
            };
            console.log('üì¶ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', result);

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ Mini App)
            if (window.Telegram && Telegram.WebApp) {
                try {
                    Telegram.WebApp.sendData(JSON.stringify(result));
                    console.log('üì§ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram');
                    Telegram.WebApp.close();
                } catch (e) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', e);
                }
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∞ –≤–Ω–µ Telegram
                alert('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω:\n' + JSON.stringify(result));
            }
        }
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
