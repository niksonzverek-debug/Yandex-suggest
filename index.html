<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #search-container { padding: 10px; background: white; z-index: 1000; }
        #address { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        #suggestions { list-style: none; padding: 0; margin: 5px 0 0; background: white; border: 1px solid #ccc; border-radius: 5px; max-height: 150px; overflow-y: auto; display: none; }
        #suggestions li { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
        #suggestions li:hover { background: #f0f0f0; }
        #map { flex: 1; width: 100%; }
        #footer { padding: 10px; background: white; border-top: 1px solid #ddd; }
        #confirm-btn { width: 100%; padding: 15px; font-size: 18px; background: #007AFF; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        #confirm-btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { text-align: center; margin-top: 8px; color: #666; font-size: 14px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="search-container">
        <input type="text" id="address" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é" autocomplete="off" autofocus>
        <ul id="suggestions"></ul>
    </div>
    <div id="map"></div>
    <div id="footer">
        <button id="confirm-btn" disabled>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å</button>
        <div class="status" id="status">‚¨ÜÔ∏è –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
    </div>

    <script>
        let map;
        let marker;
        let selectedCoords = null;
        let selectedAddress = '';
        let isProcessing = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä –¢–∞—à–∫–µ–Ω—Ç–∞)
        map = L.map('map').setView([41.311, 69.279], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–µ–º–µ—â–∞–µ–º—ã–π –º–∞—Ä–∫–µ—Ä (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç)
        marker = L.marker([41.311, 69.279], { draggable: true }).addTo(map);
        marker.on('dragend', function(e) {
            var pos = e.target.getLatLng();
            selectedCoords = [pos.lat, pos.lng];
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (–æ–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.lat}&lon=${pos.lng}&format=json`)
                .then(r => r.json())
                .then(data => {
                    selectedAddress = data.display_name || '–ü–µ—Ä–µ–º–µ—â—ë–Ω–Ω–∞—è —Ç–æ—á–∫–∞';
                    document.getElementById('address').value = selectedAddress;
                    document.getElementById('confirm-btn').disabled = false;
                    document.getElementById('status').innerText = '‚úÖ –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω —Å –∫–∞—Ä—Ç—ã';
                })
                .catch(() => {
                    selectedAddress = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
                    document.getElementById('address').value = selectedAddress;
                    document.getElementById('confirm-btn').disabled = false;
                });
        });
        // –ü—Ä—è—á–µ–º –º–∞—Ä–∫–µ—Ä, –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
        map.removeLayer(marker);

        // –ü–æ–∏—Å–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫ —á–µ—Ä–µ–∑ Nominatim
        let timeoutId = null;
        document.getElementById('address').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (query.length < 3) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }
            if (timeoutId) clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fetchSuggestions(query), 300);
        });

        function fetchSuggestions(query) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=10&countrycodes=uz`;
            fetch(url, { headers: { 'User-Agent': 'TaxiBot/1.0' } })
                .then(r => r.json())
                .then(data => displaySuggestions(data))
                .catch(err => console.error('Nominatim error:', err));
        }

        function displaySuggestions(items) {
            const list = document.getElementById('suggestions');
            list.innerHTML = '';
            if (items.length === 0) {
                list.style.display = 'none';
                return;
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.display_name;
                li.addEventListener('click', () => selectSuggestion(item));
                list.appendChild(li);
            });
            list.style.display = 'block';
        }

        function selectSuggestion(item) {
            document.getElementById('suggestions').style.display = 'none';
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);
            selectedCoords = [lat, lon];
            selectedAddress = item.display_name;
            document.getElementById('address').value = selectedAddress;
            document.getElementById('confirm-btn').disabled = false;
            document.getElementById('status').innerText = '‚úÖ –ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω –∏–∑ —Å–ø–∏—Å–∫–∞';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –º–∞—Ä–∫–µ—Ä
            if (!map.hasLayer(marker)) marker.addTo(map);
            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 15);
        }

        // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        document.getElementById('confirm-btn').addEventListener('click', function() {
            if (isProcessing || !selectedCoords) return;
            isProcessing = true;
            document.getElementById('status').innerHTML = '<span class="loader"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            const result = {
                lat: selectedCoords[0],
                lon: selectedCoords[1],
                address: selectedAddress
            };
            console.log('üì¶ –û—Ç–ø—Ä–∞–≤–∫–∞:', result);
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.sendData(JSON.stringify(result));
                setTimeout(() => Telegram.WebApp.close(), 300);
            } else {
                alert('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω:\n' + JSON.stringify(result));
                isProcessing = false;
                document.getElementById('status').innerText = '‚úÖ –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω (—Ç–µ—Å—Ç)';
            }
        });
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
